' Gambas class file

Private $sLastName As String
Private iResult As Integer

Public sDir As String = Desktop.GetDirectory("DESKTOP") & "/" 
Private sPath As String 
Public sLanguage As String = ((Left(System.Language, 2)))
Public Settings_Core_Innova As New Settings(Desktop.ConfigDir &/ "Innova/Innova_Config.conf")
Private $hWatcher As DesktopWatcher
Private sPC As String
Private sTrash As String
Public sName_Paste As String 
Public sName_Copy As String 
Private sResult_WM As String 

Public Item_Menu_Link As Menu
Public Item_Menu_Desk As Menu

'Private dm As New DesktopMime  
Private df As DesktopFile  
Private $df As DesktopFile[]
Private i As Integer

Public Sub _new()
  
  M_Theme.Show_Theme
  
  $hWatcher = New DesktopWatcher(True) As "MyDTWatcher"
  
  X11.SetWindowProperty(f_wallpaper.Id, Atom["_NET_WM_STATE"], Atom["ATOM"], Atom[" _NET_WM_STATE_BELOW"])
  X11.SetWindowProperty(f_wallpaper.Id, Atom["_NET_WM_WINDOW_TYPE"], Atom["ATOM"], Atom["_NET_WM_WINDOW_TYPE_DESKTOP"])
  
End

Public Sub Form_Open()
  
  'Dim sResult_Desktop_Wall As Integer 
  'Dim sResult_Desktop_Wall_Rand As String 
  Dim iResult_iSize_Icons As Integer 
  Dim sResult_Pos As String 
  'Dim sResult_Rnd_True As Integer 
  'Dim sResult_Dir_Wallpaper_Desktop_Random As String
  
  M_Theme.Show_Theme
  m_core.Show_Active_Time_Wallpaper_Rnd
  
  panView.Resize(Desktop.w / 2, Desktop.H - f_panel.H / 2)
  Try sResult_Pos = Settings_Core_Innova["Panel/Panel_Position", f_panel]
  If (sResult_Pos = "Top") Then
    
    ivwDesktop.y = Desktop.y + f_panel.H 
    
  Endif
  
  Try iResult_iSize_Icons = Settings_Core_Innova["Desktop/Icon_Size_Desktop"]
  
  If Not IsNull(iResult_iSize_Icons) Then
    M_Var_Global.iSize_Icons_View = iResult_iSize_Icons
  Endif
  
  Show_Files_Desktop
  
  With ivwDesktop
    
    .Background = Color.Transparent
  End With
  
  Try sResult_WM = Settings_Core_Innova["Session_Windows_Manager/Windows_Manager", f_wallpaper]
  
  If sResult_WM = "kwin_x11" Then
    
    f_wallpaper.FullScreen = True
    Me.Maximized = True 
    Me.Width = Desktop.Width 
    Me.Height = Desktop.Height 
  Else  
    Me.Maximized = True
    Me.Width = Desktop.Width
    Me.Height = Desktop.Height
  Endif
  
  Me.SetFocus
  
End

Public Sub Refresh()
  
  application.busy = 1
  ivwDesktop.Clear
  ' Wait 0.1
  Show_Files_Desktop
  application.busy = 0
  
End

Public Sub MyDTWatcher_ActiveWindow()
  
  ' application.busy = 1
  
  ' Show_Files_Desktop
  'application.busy = 0
  'Wait
  
End 

Private Sub runDesktopFile(sPath As String)
  
  Dim sDesktopFile As New DesktopFile(sPath)
  Dim $CmdArray As String[] = Split(sDesktopFile.Exec, " ", "")
  
  Try Shell $CmdArray[0]
  
End

Public Sub Show_Files_Desktop_Des()
  
  Dim sFiles As String
  Dim iSize_Icon As Integer = M_Var_Global.iSize_Icons_View 
  Dim i As Integer
  Dim img As Image
  Dim PicWall As Picture
  Dim pIcon As Picture
  Dim DesktopEntry As DesktopFile
  Dim $Files As String[]
  Dim iSize As Integer
  Dim iTam As Integer
  Dim iResult_iSize_Icons As Integer 
  Dim iResult_Icons_Line As Integer 
  Dim sPath As String
  Dim sQuery As String 
  
  ivwDesktop.Clear
  
  If (iSize_Icon > 64) Then
    iSize_Icon = iSize_Icon / 1.5
  Endif
  Settings_Core_Innova.Reload
  
  Try iResult_iSize_Icons = Settings_Core_Innova["Desktop/Icon_Size_Desktop"]
  Try iResult_Icons_Line = Settings_Core_Innova["Desktop/IconLine_Desktop"]
  
  If Not IsNull(iResult_iSize_Icons) Then
    M_Var_Global.iSize_Icons_View = iResult_iSize_Icons
  Endif
  
  If Not IsNull(iResult_Icons_Line) Then
    ivwDesktop.IconLines = iResult_Icons_Line
  Endif
  
  sPC = Settings_Core_Innova["Desktop/Show_Icon_PC"]
  sTrash = Settings_Core_Innova["Desktop/Show_Icon_Trash"]
  
  If (sPC = "1") Then
    Inc i
    
    Try ivwDesktop.Add("System", ("System"), Picture["icon:/" & iSize_Icon & "/computer"])
  Endif
  
  If (sTrash = "1") Then
    Inc i    
    Try ivwDesktop.Add("Trash", ("Trash"), Picture["icon:/" & iSize_Icon & "/trash"])
  Endif
  
  $Files = Dir(sDir, "*.png")
  $Files.Insert(Dir(sDir, "*.jpg"))
  $Files.Insert(Dir(sDir, "*.jpeg"))
  $Files.Insert(Dir(sDir, "*.bmp"))
  $Files.Insert(Dir(sDir, "*.gif"))
  $Files.Insert(Dir(sDir, "*.xpm"))
  
  For Each sFiles In Dir(sDir).Sort(gb.Descent + gb.Language)
    ' For Each sFiles In Dir(sDir).Sort(gb.Language + gb.IgnoreCase)
    If IsDir(sDir &/ sFiles) Then
      
      ivwDesktop.Add(sFiles, sFiles, Picture["icon:/" & iSize_Icon & "/directory"]).Editable = Access(sDir, gb.Write)
    Endif
  Next
  
  For Each sFiles In Dir(sDir, "*", gb.File).Sort(gb.Descent + gb.Language)
    Inc i
    img = DesktopMime.FromFile(sDir &/ sFiles).GetIcon(iSize_Icon)
    
    If Not (InStr(sFiles, ".desktop")) Then
      
      If Not (InStr(sFiles, ".jpg") Or InStr(sFiles, ".png") Or InStr(sFiles, ".bmp") Or InStr(sFiles, ".jpeg") Or InStr(sFiles, ".gif") Or InStr(sFiles, ".xpm")) Then
        ivwDesktop.Add(sFiles, sFiles, img.Picture).Editable = Access(sDir, gb.Write)
      Endif
      
    Else
      
      If Not Exist(sDir) Then Return
      DesktopEntry = New DesktopFile(sDir &/ sFiles)
      pIcon = M_DesktopEntry[DesktopEntry.Path, iSize_Icon]
      ivwDesktop.Add(sFiles, File.Name(DesktopEntry.Path), pIcon).Editable = Access(sDir, gb.Write)
    Endif
    
  Next
  
  For Each sFiles In $Files.Sort(gb.Descent + gb.Language)
    Inc i
    PicWall = Picture[sDir &/ sFiles]
    iTam = (iSize_Icon * PicWall.Height) \ PicWall.Width
    PicWall = Picture[sDir &/ sFiles].Image.Stretch(iSize_Icon, iTam).Picture
    
    ivwDesktop.Add(sFiles, sFiles, PicWall)
    
  Next
  
  'Catch
  
End

Public Sub Show_Files_Desktop()
  
  Dim sFiles As String
  Dim iSize_Icon As Integer = M_Var_Global.iSize_Icons_View 
  Dim i As Integer
  Dim img As Image
  Dim PicWall As Picture
  Dim pIcon As Picture
  Dim DesktopEntry As DesktopFile
  Dim $Files As String[]
  Dim iSize As Integer
  Dim iTam As Integer
  Dim iResult_iSize_Icons As Integer 
  Dim iResult_Icons_Line As Integer 
  Dim sPath As String
  Dim sQuery As String 
  
  ivwDesktop.Clear
  
  If (iSize_Icon > 64) Then
    iSize_Icon = iSize_Icon / 1.5
  Endif
  Settings_Core_Innova.Reload
  
  Try iResult_iSize_Icons = Settings_Core_Innova["Desktop/Icon_Size_Desktop"]
  Try iResult_Icons_Line = Settings_Core_Innova["Desktop/IconLine_Desktop"]
  
  If Not IsNull(iResult_iSize_Icons) Then
    M_Var_Global.iSize_Icons_View = iResult_iSize_Icons
  Endif
  
  If Not IsNull(iResult_Icons_Line) Then
    ivwDesktop.IconLines = iResult_Icons_Line
  Endif
  
  sPC = Settings_Core_Innova["Desktop/Show_Icon_PC"]
  sTrash = Settings_Core_Innova["Desktop/Show_Icon_Trash"]
  
  If (sPC = "1") Then
    Inc i
    
    Try ivwDesktop.Add("System", ("System"), Picture["icon:/" & iSize_Icon & "/computer"])
  Endif
  
  If (sTrash = "1") Then
    Inc i    
    Try ivwDesktop.Add("Trash", ("Trash"), Picture["icon:/" & iSize_Icon & "/trash"])
  Endif
  
  $Files = Dir(sDir, "*.png")
  $Files.Insert(Dir(sDir, "*.jpg"))
  $Files.Insert(Dir(sDir, "*.jpeg"))
  $Files.Insert(Dir(sDir, "*.bmp"))
  $Files.Insert(Dir(sDir, "*.gif"))
  $Files.Insert(Dir(sDir, "*.xpm"))
  
  For Each sFiles In Dir(sDir) '.Sort(gb.Natural)
    ' For Each sFiles In Dir(sDir).Sort(gb.Language + gb.IgnoreCase)
    If IsDir(sDir &/ sFiles) Then
      
      ivwDesktop.Add(sFiles, sFiles, Picture["icon:/" & iSize_Icon & "/directory"]).Editable = Access(sDir, gb.Write)
    Endif
  Next
  
  For Each sFiles In Dir(sDir, "*", gb.File)
    Inc i
    img = DesktopMime.FromFile(sDir &/ sFiles).GetIcon(iSize_Icon)
    
    If Not (InStr(sFiles, ".desktop")) Then
      
      If Not (InStr(sFiles, ".jpg") Or InStr(sFiles, ".png") Or InStr(sFiles, ".bmp") Or InStr(sFiles, ".jpeg") Or InStr(sFiles, ".gif") Or InStr(sFiles, ".xpm")) Then
        ivwDesktop.Add(sFiles, sFiles, img.Picture).Editable = Access(sDir, gb.Write)
      Endif
      
    Else
      
      If Not Exist(sDir) Then Return
      DesktopEntry = New DesktopFile(sDir &/ sFiles)
      pIcon = M_DesktopEntry[DesktopEntry.Path, iSize_Icon]
      ivwDesktop.Add(sFiles, File.Name(DesktopEntry.Path), pIcon).Editable = Access(sDir, gb.Write)
    Endif
    
  Next
  
  For Each sFiles In $Files
    Inc i
    PicWall = Picture[sDir &/ sFiles]
    iTam = (iSize_Icon * PicWall.Height) \ PicWall.Width
    PicWall = Picture[sDir &/ sFiles].Image.Stretch(iSize_Icon, iTam).Picture
    
    ivwDesktop.Add(sFiles, sFiles, PicWall)
    
  Next
  
  'Catch
  
End

Public Sub Form_Arrange()
  
  If sResult_WM = "kwin_x11" Then
    
    f_wallpaper.FullScreen = True
    Me.Maximized = True 
    Me.Width = Desktop.Width 
    Me.Height = Desktop.Height 
  Else  
    Me.Maximized = True
    Me.Width = Desktop.Width
    Me.Height = Desktop.Height
  Endif
  
  Me.SetFocus
  
  Me.Center
  img_Fondo.Move(Desktop.x, Desktop.y, Desktop.W, Desktop.H)
  
End

Public Sub Form_Close()
  
  Stop Event
  
End

Public Sub mnupcinfo_Click()
  
  'f_pcinfo.Show
  
  'Shell User.Home &/ "PCInfo.gambas"
  Shell "/usr/bin/pcinfo"
  
End

Public Sub mnuMyInnova_Click()
  
  'Shell User.Home &/ "QSettings.gambas"
  Shell "/usr/bin/qsettings"
  
End

Public Sub mnuWidget_Click()
  
  'Shell User.Home &/ "QSettings.gambas"
  Shell "/usr/bin/qsettings"
  
End

Public Sub menuWallpaper_Click()
  
  f_conf_wallpaper.Show
  
End

Public Sub mnuabout2_Click()
  
  f_about_dist.ShowModal
  'f_about_edulibreos.ShowModal
  
End

Public Sub mnuFolder_Click()
  
  New_Folder
  ' Dim New_sDir As String
  ' Dim sPath As String
  ' Dim iInd As Integer
  ' 
  ' New_sDir = ("New folder")
  ' iInd = 1
  ' 
  ' Do
  '   If Not Exist(sDir &/ New_sDir) Then Break
  '   Inc iInd
  '   New_sDir = ("New folder") & " (" & CStr(iInd) & ")"
  'Loop  
  
  ' sPath = sDir &/ New_sDir
  ' Mkdir sPath
  
End

Public Sub New_Folder()
  
  Dim sResult As String
  Dim sRes As String
  
  While sResult = Null
    sResult = InputBox("Folder name", ("New Folder"), ("New Folder"))
    
    If Exist(sDir &/ sResult) Then  
      Message.Title = ("Innova Desktop")
      Message(LC_MESSAGES.MSG_INF_FOLDER_EXIST)
    Endif
    
    Try Mkdir sDir &/ sResult
    
    If sResult = Null
      Message.Title = ("Innova Desktop")
      sRes = Message.Question(("Enter a Name..."), ("Ok"), ("Cancelar"))
      If sRes = 2
        Break
      Else
        Try Mkdir sDir &/ sResult
        
      Endif
    Endif
    
  Wend 
  Refresh
Catch
  Message.Title = ("Innova Desktop")
  Message.Error(("Cannot create directory.") & "\n\n" & Error.Text)
  
End

Public Sub mnuProperties_Click()
  
  f_properties.Show
  f_properties.Move(Mouse.ScreenX, Mouse.ScreenY)
  f_properties.FilePropertiesDesktop.Path = sDir
  
End

Public Sub Properties_Mixed()
  
  Dim strFiles As String[]
  Dim strData As String
  Dim strFile As String
  Dim calcSum As Integer = 0
  
  strFiles = GetSelection()
  If strFiles.Count > 0 Then
    
    For Each strFile In strFiles
      
      strFile = sDir &/ strFile
      strData = strData & strFile & "\n"
      
      With Stat(strFile)
        calcSum += Str(.Size) 
      End With
      
    Next
    
    f_properties_mixed.Show
    f_properties_mixed.Move(Mouse.ScreenX, Mouse.ScreenY) 
    f_properties_mixed.lblName.Text = ("Multiple Files")
    f_properties_mixed.lbltype.Text = ("Files of different types")
    f_properties_mixed.lbldir.Text = File.Dir(Stat(strFile).Path)
    f_properties_mixed.lbluser.Text = Stat(strFile).User
    f_properties_mixed.lblsize.Text = getText(calcSum)
    
  Endif
  
End

Public Sub mnuProperties1_Click()
  
  Dim strFiles As String[]
  
  If (ivwDesktop.Item.Key = "System") Then
    Shell "/usr/bin/pcinfo"
  Else
    
    strFiles = GetSelection()
    
    If strFiles.Count > 1 Then
      
      Properties_Mixed
    Else
      
      f_properties.Show
      f_properties.Move(Mouse.ScreenX, Mouse.ScreenY)
      f_properties.FilePropertiesDesktop.Path = sDir &/ $sLastName
      
    Endif
  Endif
  'Catch
  
End

Public Sub mnucompress_Click()
  
  f_compress.Show
  f_compress.txtfilename.Text = ivwDesktop.Current.Text
  
End

Public Sub mnucopy_Click()
  
  Dim strFiles As String[]
  Dim strData As String
  Dim strFile As String
  Dim sType As String = "text/uri-list"
  
  strFiles = GetSelection()
  If strFiles.Count > 0 Then
    
    For Each strFile In strFiles
      
      strFile = sDir &/ strFile
      strData = strData & strFile & "\n"
    Next
    strFiles.Clear()
    strFiles = Null
    Clipboard.Copy(strData, sType)
    
  Endif
  
End

Public Sub ivwDesktop_KeyPress()
  
  If (Key.Code = Key.Enter) Or (Key.Code = Key.Return) Then
    ivwDesktop_DblClick
  Endif
  
  If (Key.Code = Key.Delete) Or (Key.Code = Key.Del) Then
    mnuDelete_Click
  Endif
  
  If (Key.Code = Key.Esc) Then
    ivwDesktop.UnselectAll
    $sLastName = Null
  Endif
  
End

Public Sub ivwDesktop_MouseMove()
  
  Dim strFiles As String[]
  
  Try iResult = Settings_Core_Innova["Desktop/Popup_Info"]
  strFiles = GetSelection()
  
  If Not ivwDesktop.FindAt(Mouse.x, Mouse.y) Then  
    Try $sLastName = ivwDesktop.Item.Text
    Create_Apps_Link
    
    If Not (strFiles.Count > 1) Then
      
      If (ivwDesktop.Item.Key = "System") Or (ivwDesktop.Item.Key = "Trash") Then 
        f_popup.Close
      Else If iResult = 1 Then
        
        f_popup.Show
        f_popup.Move(ivwDesktop.Item.X + 25, ivwDesktop.Item.Y + 105) 
        f_popup.lblName.Text = File.Name(sDir & $sLastName)
        f_popup.lblsize.Text = getText(Stat(sDir & $sLastName).Size)
        f_popup.lblext.Text = DesktopMime.FromFile(sDir & $sLastName).Pattern 
        f_popup.lblcomment.Text = String.UCaseFirst(DesktopMime.FromFile(sDir & $sLastName).GetComment())
        ' f_popup.picIcon.Picture = Picture[Null]
        f_popup.picIcon.Picture = ivwDesktop.Item.Picture
        
        'f_popup.Close
      Endif
    Endif
  Endif
  
Catch
  
End

Public Sub ivwDesktop_DblClick()
  
  Dim sResult_FM As String 
  
  Dim sFM As String
  Dim sCurrent As String
  Dim sLastCurrent As String
  
  Try sLastCurrent = $sLastName
  
  Try sResult_FM = Settings_Core_Innova["Panel_Command/File_Manager", f_panel]
  
  If IsDir(sDir &/ ivwDesktop.Item.Text) Then
    
    Exec [sResult_FM, sDir &/ sLastCurrent]   
  Else
    
    If ivwDesktop.Item.Key Ends "desktop" Then 
      
      DesktopApps_Desk[File.BaseName(ivwDesktop.Item.Key)].Exec() 
      
    Else
      Desktop.Open(sDir &/ sLastCurrent)
      'Print sDir &/ sLastCurrent
      'Shell sDir &/ sLastCurrent   
    Endif
    
  Endif
  
  If File.Ext(sLastCurrent) = "gambas" Or File.Ext(sLastCurrent) = "sh" Or File.Ext(sLastCurrent) = "bin" Then
    Shell ("./" & sLastCurrent)
  Endif
  
  If (ivwDesktop.Item.Key = "System") Then
    Exec [sResult_FM, "/"]  
  Endif
  
  If (ivwDesktop.Item.Key = "Trash") Then
    sFM = (sResult_FM)
    If sFM = "Dolphin" Then
      sCurrent = ("trash:/")
      Exec [sFM, sCurrent] 
    Else
      sCurrent = ("trash:///")
      Exec [sFM, sCurrent] 
    Endif
  Endif
  
Catch
  
End

Public Sub ivwDesktop_Rename()
  
  Dim sOld As String
  Dim sLast As String
  
  sOld = sDir & $sLastName
  sLast = sDir & ivwDesktop.Item.Text
  Try Move sOld To sLast
  
End

Public Sub ivwDesktop_Menu()
  
  'Dim sFile_Select As String = ivwDesktop.Item.Text
  Dim sValue As String
  Dim sType As String = "text/uri-list"
  
  sValue = Clipboard.Paste(sType)
  If Not sValue Then 
    mnuPaste.Enabled = False
  Else
    mnuPaste.Enabled = True
  Endif
  
  ' Create_Apps_Link
  If IsNull(ivwDesktop.Item.Text) Then
    
    mnuPopup2.Popup
    
  Else
    mnuPopup.Popup
    
  Endif
Catch
  
End

Public Sub mnuDelete_Click()
  
  Dim strFiles As String[]
  Dim strData As String
  Dim strFile As String
  Dim sType As String = "text/uri-list"
  Dim sKey As String
  
  strFiles = GetSelection()
  
  If strFiles.Count > 0 Then
    Message.Title = ("Innova Desktop")
    Select Message.Question((LC_MESSAGES.MSG_QUESTION_WRITE_FILE_EXIST), ("&Yes"), ("&No"))
      Case 1
        
        For Each strFile In strFiles
          
          strFile = sDir &/ strFile
          strData = strData & strFile & "\n"
          If Not IsDir(strFile) Then 
            Try Kill strFile
            Wait 0.1
            Refresh
          Else
            Shell "rm -rf " & Shell$(strFile)
            Wait 0.1
            Refresh
          Endif  
          
        Next
      Case 2
        ivwDesktop.UnselectAll
        
    End Select
    
    strFiles.Clear()
    strFiles = Null
    
  Endif
  
End

Public Sub mnuSelectall_Click()
  
  ivwDesktop.SelectAll
  
End

Public Sub mnulink_Click()
  
  Dim I As Integer
  Dim sName As String
  Dim sExt As String
  
  Inc i
  sName = File.BaseName(sDir & ivwDesktop.Item.Text)
  sExt = File.Ext(sDir & ivwDesktop.Item.Text)
  
  If sExt = Null Then
    Link sDir & ivwDesktop.Item.Text To sDir & sName & "_" & i & sExt
  Else
    Link sDir & ivwDesktop.Item.Text To sDir & sName & "_" & i & "." & sExt
  Endif
  
End

Public Sub mnuNewFile_Click()
  
  Dim sResult As String
  Dim sRes As String
  Dim hFile As File
  
  While sResult = Null
    sResult = InputBox("New File", ("New File"), ("New File"))
    
    If Exist(sDir &/ sResult) Then
      Message.Title = ("Innova Desktop")
      Message(LC_MESSAGES.MSG_INF_FILE_EXIST)
    Endif
    
    Try hFile = Open sDir &/ sResult For Create
    
    If sResult = Null
      Message.Title = ("Innova Desktop")
      sRes = Message.Question((LC_MESSAGES.MSG_QUESTION_RES_NEW_FILE), ("Ok"), ("Cancelar"))
      If sRes = 2
        Break
      Else
        Try hFile = Open sDir &/ sResult For Create
        
      Endif
    Endif
    
  Wend 
  Refresh
  
End

Private Sub GetSelection() As String[]
  
  Dim hView As Object
  Dim aSel As New String[]
  
  ivwDesktop.MoveFirst
  While ivwDesktop.Available
    If ivwDesktop.Item.Selected Then
      aSel.Add(ivwDesktop.Item.Text)
    Endif
    ivwDesktop.MoveNext
  Wend
  
  Return aSel
  
End

Private Function getText(argSize As Integer) As String
  
  If 1024 > argSize Then 'byte
    Return Format$(argSize, "##0 Byte")
  Else If 1024 ^ 2 > argSize Then 'KiB
    Return Format$(argSize / 1024, "##0.00 KB")
  Else If 1024 ^ 3 > argSize Then 'MiB
    Return Format$(argSize / (1024 ^ 2), "##0.00 MB")
  Else If 1024 ^ 4 > argSize Then 'GiB
    Return Format$(argSize / (1024 ^ 3), "##0.00 GB")
  Else If 1024 ^ 5 > argSize Then 'TiB
    Return Format$(argSize / (1024 ^ 4), "##0.00 TB")
  Else
    Return "Null"
  Endif
  
End

Static Private Function URLDecode(txt As String) As String
  
  Dim txt_len As Integer
  Dim i As Integer
  Dim ch As String
  Dim digits As String
  Dim resultado As String
  
  resultado = ""
  txt_len = Len(txt)
  i = 1
  Do While i <= txt_len
    
    ch = Mid$(txt, i, 1)
    If ch = "+" Then
      
      resultado = resultado & " "
    Else If ch <> "%" Then
      
      resultado = resultado & ch
    Else If i > txt_len - 2 Then
      resultado = resultado & ch
    Else
      
      digits = Mid$(txt, i + 1, 2)
      
      resultado = resultado & Chr$(CInt(Val("&" & digits)))
      i = i + 2
    Endif
    i = i + 1
  Loop
  
  Return resultado
  
End

Public Sub Cp_File()
  
  Dim flOr, flCp As File
  Dim origo, copia As String
  Dim bb As Byte[]
  Dim quantum, lo As Integer
  Dim l As Long
  Dim a As String
  Dim b As String[]
  Dim sDir As String
  Dim sCopy As String
  Dim sResult As String
  
  Dim nFiles As Integer
  Dim sName As String
  Dim iSize As Float
  
  sDir = Desktop.GetDirectory("DESKTOP") 
  a = Clipboard.Paste("text/uri-list") 
  b = Split(a, gb.CrLf, "", True)
  a = Null 
  
  For Each a In b
    a = Right$(a, -7) 
    a = URLDecode(a)  
    a = RTrim(a)
    origo = a
    copia = sDir &/ File.Name(a)
    
    flOr = Open origo For Read
    
    flCp = Open copia For Create
    
    lo = Lof(flOr)
    
    quantum = lo \ 100
    
    bb = New Byte[quantum + (lo Mod 100)]
    
    While Not Eof(flOr)
      If lo - Seek(flOr) < quantum Then quantum = lo - Seek(flOr)
      bb.Read(flOr, 0, quantum)
      bb.Write(flCp, 0, quantum)
      l += quantum
      f_progressbar.ProgressBar1.Value = ((l * 100) \ lo) / 100
      Wait 0.001
    Wend
  Next
  flCp.Close
  flOr.Close
Catch
  
End

Public Function Mimex(strMimeType As String) As String[] ''Devuelve una lista de los programas que estan asociados al tipo mime que se pasa como parametro.
  
  Dim stxOut As New String[]
  Dim df As DesktopFile
  
  For Each df In DesktopFile.FromMime(strMimeType)
    stxOut.Add(df.ProgramName)
  Next
  
  Return stxOut
  
End

Public Sub Items_Click()
  
  sPath = sDir &/ ivwDesktop.Item.Text
  With df = DesktopFile.FromMime(DesktopMime.FromFile(sPath).Type)[Last.tag - 1]  
    ' Message(sPath)
    df.Run(sPath)
  End With
  
End

Public Sub Create_Apps_Link()
  
  Dim sMimeType As String
  Dim i As Integer
  Dim hFile As DesktopFile[]
  
  sPath = sDir &/ ivwDesktop.Item.Text
  Try sMimeType = DesktopMime.FromFile(sPath).Type
  mnuOpen.Visible = True
  mnuOpenwith.Visible = True
  mnuOpenwith.Children.Clear
  
  If IsDir(sPath) Then 
    'hFile = DesktopFile.FromMime("inode/directory")
    ' mnuOpenwith.Children.Clear
    mnuOpenwith.Visible = False
    mnuOpen.Visible = False
    
    ' For Each df In hFile
    
    '  Item_Menu_Link = New Menu(mnuOpenwith) As "Items" 
    '  Item_Menu_Link.text = df.Name
    '  Item_Menu_Link.Picture = df.GetIcon(16).Picture
    '  Item_Menu_Link.Tag = i
    
    'Next
    
  Endif
  
  For Each df In DesktopFile.FromMime(DesktopMime.FromFile(sPath).Type)
    Inc i
    
    Item_Menu_Link = New Menu(mnuOpenwith) As "Items" 
    Item_Menu_Link.text = df.Name
    Item_Menu_Link.Picture = df.GetIcon(16).Picture
    Item_Menu_Link.Tag = i 
    
  Next
  
  If sPath Ends ".desktop" Then 
    hFile = DesktopFile.FromMime("text/plain")
    ' For Each df In DesktopFile.FromMime(DesktopMime.FromFile(sPath).Type)
    'For Each df In hFile
    For i = 0 To hFile.Max 
      'Print hTest[idx].Name
      
      Item_Menu_Link = New Menu(mnuOpenwith) As "Items" 
      Item_Menu_Link.text = hFile[i].Name
      Item_Menu_Link.Picture = hFile[i].GetIcon(16).Picture
      Item_Menu_Link.Tag = i
      
    Next
  Endif
  
Catch
  
End

Public Sub mnuRefresh1_Click()
  
  Refresh
  
End

Public Sub mnuAscending_Click()
  '' metodo burbuja, cambiar en un futuro
  
  If mnuAscending.Radio = True Then
    ivwDesktop.Sorted = True
    ivwDesktop.Clear
    Show_Files_Desktop
  Endif
  
End

Public Sub ivwDesktop_Select()
  
  Try $sLastName = ivwDesktop.Item.Text
  
  If ivwDesktop.Item.Text Then sName_Copy = ivwDesktop.Item.Text
  ''Create_Apps_Link
  
  If ivwDesktop.Item.Text = Null Then
    $sLastName = Null
  Endif
  
  If (ivwDesktop.Item.Key = "System") Or (ivwDesktop.Item.Key = "Trash") Then 
    mnucopy.Visible = False
    mnutrash.Visible = False
    mnuDelete.Visible = False
    mnuOpen.Visible = False
    mnucompress.Enabled = False
    
  Else
    mnucopy.Visible = True
    mnutrash.Visible = True
    mnuDelete.Visible = True
    mnuOpen.Visible = True
    mnucompress.Visible = True
    mnucompress.Enabled = True
  Endif
  
  If $sLastName Like "*.tar.gz" Or If $sLastName Like "*.tar.bz2" Or If $sLastName Like "*.tgz" Or If $sLastName Like "*.tar" Or If $sLastName Like "*.zip" Then
    
    mnuUncompress.Visible = True
    mnucompress.Visible = False
    
  Else
    
    mnucompress.Visible = True
    mnuUncompress.Visible = False
    
  Endif
  
Catch
  
End

Public Sub mnutrash_Click()
  
  Dim strFiles As String[]
  Dim strData As String
  Dim strFile As String
  Dim sType As String = "text/uri-list"
  Dim sOrigen As String
  Dim sDestiny As String
  
  sDestiny = Desktop.DataDir &/ "Trash/info"
  
  strFiles = GetSelection()
  If strFiles.Count > 0 Then
    Message.Title = ("Innova Desktop")
    Select Message.Question((LC_MESSAGES.MSG_QUESTION_DELETE_FILE_TRASH), ("&Yes"), ("&No"))
      Case 1
        
        For Each strFile In strFiles
          strFile = sDir &/ strFile
          strData = strData & strFile & "\n"
          Shell "mv -f " & Shell$(strFile) & " " & Desktop.DataDir &/ "Trash/info"
          Wait 0.1
          Refresh
        Next
        
      Case 2
        ivwDesktop.UnselectAll
        
    End Select
    
    strFiles.Clear()
    strFiles = Null
    
  Endif
  
End

Public Sub Items_Click001()
  
  sPath = sDir &/ ivwDesktop.Item.Text
  
  With df = DesktopFile.FromMime(DesktopMime.FromFile(sPath).Type)[Last.tag - 1]  
    Message(sPath)
    df.Run(sPath)
  End With
  
End

Public Sub mnuOpen_Click()
  
  ivwDesktop_DblClick
  
End

Public Sub mnuSelectApps_Click()
  
End

Public Sub mnuRefresh_Click()
  
  Refresh
  
End

Public Sub mnuPaste_Click()
  
  Dim a As String
  Dim b As String[]
  Dim sDir As String
  Dim sCopy As String
  Dim sResult As String
  
  Dim nFiles As Integer
  Dim sName As String
  Dim iSize As Float
  
  sDir = Desktop.GetDirectory("DESKTOP") 
  a = Clipboard.Paste("text/uri-list") 
  b = Split(a, gb.CrLf, "", True)
  
  a = Null 
  
  nFiles = 0
  nFiles = b.Count
  
  f_progressbar.Show
  f_progressbar.ProgressBar1.Value = 0
  
  If sDir Then
    
    For Each a In b
      a = Right$(a, -7) 
      a = URLDecode(a)  
      a = RTrim(a)
      
      If Exist(sDir &/ File.Name(a)) Then
        Message.Title = ("Innova Desktop - Copy File")
        Message.Error((LC_MESSAGES.MSG_ERR_CP_ITEMS))
        f_progressbar.Close
        Exit
        '  Else
        
        ' If Exist(sDir &/ File.Name(a)) Then
        '   Message.Title = ("Innova Desktop - Copy File")
        '   If Message.Question("<span style=\"color:#" & "0000FF" & ";margin-left:1em;\">" & ("There is already a file with the same name in this location.  ") & "</span>" & "<b><span style=\"color:#" & "088906" & ";margin-left:1em;\">" & UCase(File.Name(a)) & "</span></b>" & "<span style=\"color:#" & "CC0000" & ";margin-left:1em;\">" & (" Overwrite it with the new file?"), ("Copy and Replace"), ("Don't Copy")) = 1 Then
        '     Try Kill sDir &/ File.Name(a)
        '     f_progressbar.Close
        '   Endif
      Endif
      
      If Not IsDir(a) Then 
        
        sName = Left$(a, -4)
        
        f_progressbar.lblStatus2.Text = ("Copying ") & nFiles & (" Items ")
        f_progressbar.lblStatus.Text = ("Copying ") & File.Name(a) & (" To ") & sDir
        iSize = Stat(a).Size
        
        f_progressbar.lblSize.Text = getText(iSize)
        Cp_File
        ' Endif
      Else
        sName = Left$(a, -4) 
        
        f_progressbar.lblStatus2.Text = ("Copying ") & nFiles & (" Items ")
        f_progressbar.lblStatus.Text = ("Copying ") & File.Name(a) & (" To ") & sDir
        iSize = Stat(a).Size
        f_progressbar.lblSize.Text = getText(iSize)
        f_progressbar.ProgressBar1.Value += (1 / nFiles) 
        f_progressbar.ProgressBar1.Background = &336b87&
        
        Wait 0.5
        sCopy = "cp -R " & a & " " & sDir
        Shell sCopy Wait
        
      Endif 
      
      ' Show_Files_Desktop
    Next
    
    f_progressbar.Hide
  Else
    Message.Title = ("Innova Desktop - Copy File")
    Message.Info(("An unknown error has occurred."))
  Endif  
  
  Refresh
Catch
  
End

Public Sub mnuabout3_Click()
  
  f_about.ShowModal
  
End

Public Sub ivwDesktop_Click()
  
  Create_Apps_Link
  
End

Public Sub mnuName_Click()
  
  ivwDesktop.Clear
  
  Refresh
  
End

Public Sub mnuDescending_Click()
  
  If mnuDescending.Radio = True Then
    ' ivwDesktop.Sorted = False
    ivwDesktop.Clear
    Show_Files_Desktop_Des
  Endif
  
End
